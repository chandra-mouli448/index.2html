import React, { useState } from "react";
import { ethers } from "ethers";

// âœ… Replace with your ABI & Contract Address
const contractABI = [ /* paste your ABI here */ ];
const contractAddress = "0xC2e0620752E4115cA679d71Ad2c9ee63f2d046Fc";

export default function LoanDapp() {
  const [wallet, setWallet] = useState(null);
  const [fileHash, setFileHash] = useState("");
  const [status, setStatus] = useState("");
  const [fileName, setFileName] = useState("");

  // Connect wallet
  const connectWallet = async () => {
    if (window.ethereum) {
      try {
        const provider = new ethers.BrowserProvider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        const signer = await provider.getSigner();
        setWallet(signer);
        setStatus("âœ… Wallet Connected!");
      } catch (err) {
        console.error(err);
        setStatus("âŒ Wallet Connection Failed");
      }
    } else {
      alert("Install MetaMask!");
    }
  };

  // File upload & hash calculation
  const handleFileUpload = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    setFileName(file.name);

    const reader = new FileReader();
    reader.onload = async (event) => {
      const fileBuffer = new Uint8Array(event.target.result);
      const hash = ethers.keccak256(fileBuffer);
      setFileHash(hash);
      setStatus(`ğŸ“‚ File "${file.name}" uploaded & hashed!`);
    };
    reader.readAsArrayBuffer(file);
  };

  // Submit Document
  const submitDocument = async () => {
    if (!wallet || !fileHash) {
      setStatus("âš ï¸ Connect wallet & upload file first!");
      return;
    }

    try {
      const contract = new ethers.Contract(contractAddress, contractABI, wallet);
      const tx = await contract.submitDocument(fileHash);
      await tx.wait();
      setStatus("âœ… Document submitted successfully!");
    } catch (err) {
      console.error(err);
      setStatus("âŒ Transaction Failed");
    }
  };

  return (
    <div className="min-h-screen flex flex-col items-center justify-center bg-gradient-to-r from-purple-600 via-pink-500 to-red-500 p-6">
      <div className="bg-white shadow-2xl rounded-2xl p-8 w-full max-w-lg text-center">
        <h1 className="text-3xl font-extrabold text-purple-700 mb-6">
          ğŸŒˆ Decentralized Loan DApp
        </h1>

        {/* Connect Wallet */}
        <button
          onClick={connectWallet}
          className="mb-6 px-6 py-3 rounded-xl bg-gradient-to-r from-green-400 to-green-600 text-white font-bold shadow-lg hover:scale-105 transition"
        >
          {wallet ? "âœ… Wallet Connected" : "ğŸ”— Connect Wallet"}
        </button>

        {/* File Upload */}
        <div className="mb-6">
          <label className="block text-lg font-semibold text-gray-700 mb-2">
            ğŸ“‚ Upload Document
          </label>
          <input
            type="file"
            accept="*/*"
            onChange={handleFileUpload}
            className="block w-full text-sm text-gray-700 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none focus:ring-2 focus:ring-purple-500"
          />
          {fileName && (
            <p className="mt-2 text-sm text-gray-600">Selected: {fileName}</p>
          )}
        </div>

        {/* Submit Button */}
        <button
          onClick={submitDocument}
          className="w-full px-6 py-3 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-bold shadow-lg hover:scale-105 transition"
        >
          ğŸš€ Submit Document
        </button>

        {/* Status */}
        {status && (
          <p className="mt-6 text-lg font-medium text-gray-800">{status}</p>
        )}
      </div>
    </div>
  );
}
